CC = @CC@
CFLAGS = @CFLAGS@ @SOUP_CFLAGS@ -Wall -I. -Iinclude -pedantic
LIBS = @LIBS@ @SOUP_LIBS@

TARGET       = wp-backup
SRCDIR       = src
INCDIR       = include
BUILDDIR     = build
OBJDIR       = build/obj

OBJS =	debug.o			\
	http-client.o		\
	http-request.o		\
	http-response.o		\
	options.o		\
	password-resolver.o	\
	utils.o			\
	wordpress.o

OBJECTS = $(OBJS:%.o=$(OBJDIR)/%.o)


.PHONY: all install uninstall dist clean

all: $(BUILDDIR)/$(TARGET)

install:
ifeq ("$(wildcard $(BUILDDIR)/$(TARGET))", "")
	$(error "Application has not been compiled yet. Run `make`.")
endif
	cp -f $(BUILDDIR)/$(TARGET) /usr/bin/wp-backup
	chmod +x /usr/bin/wp-backup

uninstall:
	rm -f /usr/bin/wp-backup

$(BUILDDIR)/$(TARGET): $(OBJECTS) $(SRCDIR)/wp-backup.c include/wp-backup.h
	$(CC) $(SRCDIR)/wp-backup.c $(OBJECTS) $(CFLAGS) $(LIBS) $(DEBUG) -o $@

$(OBJECTS): $(OBJDIR)/%.o : $(SRCDIR)/%.c	\
		$(INCDIR)/wp-backup/%.h		\
		include/wp-backup.h
	@mkdir -p $(OBJDIR)
	$(CC) $(CFLAGS) $(LIBS) $(DEBUG) -c $< -o $@

dist:	clean
	cd ..; \
	tar cfvz $(TARGET)/$(TARGET).tar.gz --exclude=$(TARGET)/test.sh	\
		$(TARGET)/*

clean:
	rm -rf $(BUILDDIR) $(TARGET).tar.gz
	rm -rf autom4te.cache
	rm -f aclocal.m4 config.log stamp-h1
	rm -f compile config.status configure install-sh missing
	rm -f config.h* config.make
	rm -f *.gcda *.gcno
	rm -f Makefile

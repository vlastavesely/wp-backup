PROGNAME := wp-backup

SRCFILES := $(shell find src -type f -name "*.c")
OBJFILES := $(patsubst %.c, %.o, $(SRCFILES))
TEST_SRCFILES := $(shell find tests -type f -name "*.c")
TEST_OBJFILES := $(patsubst %.c, %.o, $(TEST_SRCFILES))
TEST_OBJFILES += $(filter-out src/wp-backup.o, $(OBJFILES))

CC = @CC@

CFLAGS := @CFLAGS@ @LIBXML_CFLAGS@ @CURL_CFLAGS@ -I.
CFLAGS += @DEBUG_CFLAGS@
LIBS := @LIBXML_LIBS@ @CURL_LIBS@
LDFLAGS := $(LIBS)

.PHONY: all install uninstall clean distclean test


all: $(PROGNAME)

test: tests/test
	tests/test

$(PROGNAME): $(OBJFILES)
	$(CC) $(LDFLAGS) $^ -o $(PROGNAME)

tests/test: $(TEST_OBJFILES)
	$(CC) $(LDFLAGS) $^ -o tests/test -lcunit

%.o: %.c Makefile
	$(CC) $(CFLAGS) $(LIBS) -MMD -MP -c $< -o $@

install:
	cp -f $(PROGNAME) /usr/$(PROGNAME)
	chmod +x /usr/bin/$(PROGNAME)

uninstall:
	$(RM) -f /usr/bin/wp-backup

clean:
	$(RM) -f *.d */*.d *.o */*.o $(PROGNAME) tests/test
	$(RM) -f *.gcda */*.gcda *.gcno */*.gcno

distclean: clean
	$(RM) -rf autom4te.cache aclocal.m4
	$(RM) -f autoscan.log configure.scan
	$(RM) -f config.* configure install-sh
	$(RM) -f Makefile

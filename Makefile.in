#
# Copyright (c) 2017 Vlasta Vesely <vlastavesely@protonmail.ch>
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/>.
#

PROGNAME := wp-backup

PREFIX=/usr

SRCFILES := $(shell find src -type f -name "*.c")
OBJFILES := $(patsubst %.c, %.o, $(SRCFILES))
TEST_SRCFILES := $(shell find tests -type f -name "*.c")
TEST_OBJFILES := $(patsubst %.c, %.o, $(TEST_SRCFILES))
TEST_OBJFILES += $(filter-out src/wp-backup.o, $(OBJFILES))

CC = @CC@

CFLAGS := @CFLAGS@ @LIBXML_CFLAGS@ @CURL_CFLAGS@ -I. -Wall
CFLAGS += @COVERAGE_CFLAGS@
LIBS := @LIBXML_LIBS@ @CURL_LIBS@
LDFLAGS := $(LIBS)

.PHONY: all install uninstall clean distclean test


all: $(PROGNAME)

test: tests/test
	tests/test

$(PROGNAME): $(OBJFILES)
	$(CC) $(CFLAGS) $(LDFLAGS) $^ -o $(PROGNAME)

tests/test: $(TEST_OBJFILES)
	$(CC) $(CFLAGS) $(LDFLAGS) $^ -o tests/test -lcunit

%.o: %.c Makefile
	$(CC) $(CFLAGS) $(LIBS) -MMD -MP -c $< -o $@


doc/wp-backup.1.gz:
	gzip < doc/wp-backup.1 > doc/wp-backup.1.gz

install: all doc/wp-backup.1.gz
	cp -f $(PROGNAME) $(PREFIX)/bin/$(PROGNAME)
	chmod +x $(PREFIX)/bin/$(PROGNAME)
	cp -f doc/wp-backup.1.gz $(PREFIX)/share/man/man1

uninstall:
	$(RM) -f $(PREFIX)/bin/wp-backup
	$(RM) -f $(PREFIX)/share/man/man1/wp-backup.1.gz

clean:
	$(RM) -f */*.d */*.o $(PROGNAME) tests/test doc/*.gz
	$(RM) -f */*.gcda */*.gcno

distclean: clean
	$(RM) -rf autom4te.cache aclocal.m4
	$(RM) -f autoscan.log configure.scan
	$(RM) -f config.* configure install-sh
	$(RM) -f Makefile
